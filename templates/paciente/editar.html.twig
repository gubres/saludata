{% extends 'base.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.container {
			max-width: 70%;
			margin: auto;
			padding-top: 20px;
		}

		.card {
			background: #ffffff;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			padding: 20px;
			border-radius: 8px;
		}

		.form-group {
			display: flex;
			align-items: center;
			margin-bottom: 10px;
		}

		.form-group label {
			flex: 0 0 180px;
			margin-right: 10px;
		}

		.form-control {
			flex: 1;
		}

		#selectFoto {
			width: auto;
			max-width: 100%;
			max-height: 45px;
			white-space: nowrap;
			padding: 10px 20px; /* Ajusta el padding si es necesario */
			margin: 5px; /* Añade margen para separarlos */
		}

		#file-display-container {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#video {
			max-width: 30%;
			height: auto;
			margin-bottom: 20px;
			margin-right: 20px;
		}
		#photo {
			max-width: 100%;
			height: auto;
			margin-bottom: 10px;
		}

		.btn {
			width: fit-content;
			padding: 8px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			white-space: nowrap;
		}

		.btn-primary {
			color: white;
			background-color: #007bff;
		}
		.btn-info {
			background-color: #17a2b8;
			color: white;
		}

		.btn-info:hover {
			background-color: #138496;
		}

		.btn-danger {
			background-color: #dc3545;
			color: white;
		}

		.btn:hover {
			opacity: 0.85;
		}

		#file-name {
			margin-right: 10px;
		}
		.form-control[readonly] {
			background-color: #e9ecef; /* Color gris claro */
			opacity: 1;
		}
	</style>
{% endblock %}

{% block title %}Editar Paciente
{% endblock %}

{% block body %}
	{% if is_granted('IS_AUTHENTICATED_FULLY') %}
		<main class="flex-1 pt-5 mt-5">
			<section class="container">
				<article class="card text-center">
					<h4 class="pt-3 mt-3">EDITAR PACIENTE</h4>
					<div class="card-body">
						<form id="editPatientForm" method="post" action="{{ path('paciente_editar', {'id': paciente.id}) }}" enctype="multipart/form-data">
							<div class="row">
								<div class="col-md-6 form-group">
									<label>Foto del paciente</label>
									<div class="d-flex justify-content-center">
										{% if imagen %}
											<img id="photo" class="mb-3 img-fluid" src="{{ imagen }}" style="display: block;">
										{% else %}
											<img id="photo" class="mb-3 img-fluid" style="display: none;">
										{% endif %}
									</div>
								</div>
								<div id="file-display-container" class="col-md-6 form-group d-flex flex-column justify-content-center align-items-center">
									<input type="file" id="image-upload" name="imagen" accept="image/png, image/jpeg, image/gif, image/webp" style="display: none;">
									<label for="image-upload" class="btn btn-info bi bi-images mt-2" id="selectFoto">Seleccionar nueva foto</label>
									<button type="button" id="camera-button" class="btn btn-info bi bi-camera2 mt-2">Usar cámara</button>
									<button type="button" id="remove-file" class="btn btn-danger mt-2 mb-2" style="display: none;">Borrar imagen</button>
									<span id="file-name"></span>
								</div>
							</div>
							<div id="file-display-container" class="form-group d-flex flex-column align-items-center">
								<video id="video" autoplay class="video-preview mb-3" style="display: none; max-width: 30%; height: auto;"></video>
								<button id="snap" class="btn btn-primary" style="display: none;">Capturar Foto</button>
								<canvas id="canvas" style="display: none;"></canvas>
							</div>
							<div class="row">
								<div class="col-md-6 form-group">
									<label>Nombre</label>
									<input class="form-control" type="text" name="nombre" value="{{ paciente.nombre }}" required>
								</div>
								<div class="col-md-6 form-group">
									<label>Apellidos</label>
									<input class="form-control" type="text" name="apellidos" value="{{ paciente.apellido }}" required>
								</div>
							</div>
							<div class="row">
								{% if is_granted('ROLE_ADMIN') %}
									<div class="col-md-6 form-group">
										<label>DNI/NIE</label>
										<input class="form-control" type="text" name="dni" value="{{ paciente.dni }}">
									</div>
								{% else %}
									<div class="col-md-6 form-group">
										<label>DNI/NIE</label>
										<input class="form-control" type="text" name="dni" value="{{ paciente.dni }}" readonly>
									</div>
								{% endif %}
								<div class="col-md-6 form-group">
									<label>Fecha Nacimiento</label>
									<input class="form-control" type="date" name="fecha_nacimiento" value="{{ paciente.fechaNacimiento|date('Y-m-d') }}" required>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 form-group">
									<label>Profesion</label>
									<input class="form-control" type="text" name="profesion" value="{{ paciente.profesion }}">
								</div>
								<div class="col-md-6 form-group">
									<label>Dirección</label>
									<input class="form-control" type="text" name="direccion" value="{{ paciente.direccion }}">
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 form-group">
									<label>Ciudad</label>
									<input class="form-control" type="text" name="ciudad" value="{{ paciente.ciudad }}">
								</div>
								<div class="col-md-6 form-group">
									<label>Comunidad Autónoma</label>
									<select class="form-control" name="comunidadAutonoma">
										<option value="">Seleccione una comunidad autónoma</option>
										<option value="Andalucía" {% if paciente.comunidadAutonoma == 'Andalucía' %} selected {% endif %}>Andalucía</option>
										<option value="Aragón" {% if paciente.comunidadAutonoma == 'Aragón' %} selected {% endif %}>Aragón</option>
										<option value="Asturias" {% if paciente.comunidadAutonoma == 'Asturias' %} selected {% endif %}>Asturias</option>
										<option value="Baleares" {% if paciente.comunidadAutonoma == 'Baleares' %} selected {% endif %}>Baleares</option>
										<option value="Canarias" {% if paciente.comunidadAutonoma == 'Canarias' %} selected {% endif %}>Canarias</option>
										<option value="Cantabria" {% if paciente.comunidadAutonoma == 'Cantabria' %} selected {% endif %}>Cantabria</option>
										<option value="Castilla y León" {% if paciente.comunidadAutonoma == 'Castilla y León' %} selected {% endif %}>Castilla y León</option>
										<option value="Castilla-La Mancha" {% if paciente.comunidadAutonoma == 'Castilla-La Mancha' %} selected {% endif %}>Castilla-La Mancha</option>
										<option value="Cataluña" {% if paciente.comunidadAutonoma == 'Cataluña' %} selected {% endif %}>Cataluña</option>
										<option value="Extremadura" {% if paciente.comunidadAutonoma == 'Extremadura' %} selected {% endif %}>Extremadura</option>
										<option value="Galicia" {% if paciente.comunidadAutonoma == 'Galicia' %} selected {% endif %}>Galicia</option>
										<option value="Madrid" {% if paciente.comunidadAutonoma == 'Madrid' %} selected {% endif %}>Madrid</option>
										<option value="Murcia" {% if paciente.comunidadAutonoma == 'Murcia' %} selected {% endif %}>Murcia</option>
										<option value="Navarra" {% if paciente.comunidadAutonoma == 'Navarra' %} selected {% endif %}>Navarra</option>
										<option value="País Vasco" {% if paciente.comunidadAutonoma == 'País Vasco' %} selected {% endif %}>País Vasco</option>
										<option value="La Rioja" {% if paciente.comunidadAutonoma == 'La Rioja' %} selected {% endif %}>La Rioja</option>
										<option value="Valencia" {% if paciente.comunidadAutonoma == 'Valencia' %} selected {% endif %}>Valencia</option>
										<option value="Ceuta" {% if paciente.comunidadAutonoma == 'Ceuta' %} selected {% endif %}>Ceuta</option>
										<option value="Melilla">Melilla</option>
									</select>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 form-group">
									<label>País</label>
									<input class="form-control" type="text" name="pais" value="{{ paciente.pais }}" readonly>
								</div>
								<div class="col-md-6 form-group">
									<label>Seleccione el género</label>
									<select class="form-control" id="genderSelect" name="genero" required>
										<option value="hombre-cis" {% if paciente.genero == 'hombre-cis' %} selected {% endif %}>Hombre Cis</option>
										<option value="hombre-trans" {% if paciente.genero == 'hombre-trans' %} selected {% endif %}>Hombre Trans</option>
										<option value="mujer-cis" {% if paciente.genero == 'mujer-cis' %} selected {% endif %}>Mujer Cis</option>
										<option value="mujer-trans" {% if paciente.genero == 'mujer-trans' %} selected {% endif %}>Mujer Trans</option>
										<option value="non-binario" {% if paciente.genero == 'non-binario' %} selected {% endif %}>Non-Binario</option>
										<option value="neutro" {% if paciente.genero == 'neutro' %} selected {% endif %}>Neutro</option>
										<option value="agenero" {% if paciente.genero == 'agenero' %} selected {% endif %}>Agenero</option>
										<option value="pangenero" {% if paciente.genero == 'pangenero' %} selected {% endif %}>Pangenero</option>
										<option value="queer" {% if paciente.genero == 'queer' %} selected {% endif %}>Queer</option>
										<option value="no-identificar" {% if paciente.genero == 'no-identificar' %} selected {% endif %}>No Identificar</option>
									</select>
								</div>
							</div>
							<div class="row">
								<div class="col-md-6 form-group">
									<label>Seleccione el estado civil</label>
									<select class="form-control" name="estado_civil" required>
										<option value="soltero(a)" {% if paciente.estadoCivil == 'soltero(a)' %} selected {% endif %}>Soltero(a)</option>
										<option value="casado(a)" {% if paciente.estadoCivil == 'casado(a)' %} selected {% endif %}>Casado(a)</option>
										<option value="viudo(a)" {% if paciente.estadoCivil == 'viudo(a)' %} selected {% endif %}>Viudo(a)</option>
										<option value="pareja de hecho" {% if paciente.estadoCivil == 'pareja de hecho' %} selected {% endif %}>Pareja de Hecho</option>
										<option value="no identificar" {% if paciente.estadoCivil == 'no identificar' %} selected {% endif %}>No Identificar</option>
									</select>
								</div>
								<div class="col-md-6 form-group">
									<label>Teléfono</label>
									<input class="form-control" type="tel" name="telefono" value="{{ paciente.telefono }}" placeholder="Teléfono de Contacto">
								</div>

								<div class="col-md-6 form-group">
									<label>Email</label>
									<input class="form-control" type="email" name="email" value="{{ paciente.email }}" placeholder="Email de Contacto">
								</div>
							</div>
							<div class="d-flex justify-content-center p-3">
								<button type="submit" class="btn btn-primary bi bi-check2-square">
									Guardar Cambios</button>
								<a href="{{ path('paciente_ver', {'id': paciente.id}) }}" class="btn btn-secondary bi bi-person-lines-fill mx-2">
									Volver
								</a>
							</div>
						</form>
					</div>
				</article>
			</section>
		</main>

	{% endif %}
{% endblock %}

{% block javascripts %}
  	<script>
		if (!window.location.hash.includes('editar')) {
window.location.hash = 'editar';
window.location.reload();
}
	</script>
	
{{ parent() }}
<script>
	document.addEventListener('DOMContentLoaded', function () {
		const fileInput = document.getElementById('image-upload');
		const cameraButton = document.getElementById('camera-button');
		const selectButtonLabel = document.querySelector('label[for="image-upload"]');
		const fileNameContainer = document.getElementById('file-name');
		const removeFileButton = document.getElementById('remove-file');
		const video = document.getElementById('video');
		const snap = document.getElementById('snap');
		const photo = document.getElementById('photo');
		const canvas = document.getElementById('canvas');

		cameraButton.addEventListener('click', function () {
		if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		navigator.mediaDevices.getUserMedia({video: true}).then(function (stream) {
		video.style.display = 'block';
		snap.style.display = 'block';
		video.srcObject = stream;
		video.play();
		selectButtonLabel.style.display = 'none'; // Oculta el botón de seleccionar archivo
		cameraButton.style.display = 'none'; // Oculta el botón de usar cámara
		}).catch(function (error) {
		console.error("Error accessing the camera: " + error);
		});
		}
		});

		snap.addEventListener('click', function (event) {
		event.preventDefault(); // Previene el envío del formulario
		var desiredWidth = video.videoWidth;
		var desiredHeight = video.videoHeight;
		var aspectRatio = video.videoWidth / video.videoHeight;
		if (desiredWidth > 400) {
		desiredWidth = 400;
		desiredHeight = desiredWidth / aspectRatio;
		}
		canvas.width = desiredWidth;
		canvas.height = desiredHeight;
		canvas.getContext('2d').drawImage(video, 0, 0, desiredWidth, desiredHeight);
		photo.src = canvas.toDataURL('image/png');
		photo.style.display = 'block';
		video.srcObject.getTracks().forEach(track => track.stop());

		// Convertir canvas a Blob y luego asignarlo como valor del input file
		canvas.toBlob(function (blob) {
		const file = new File([blob], "captura.png", {type: "image/png"});
		const dataTransfer = new DataTransfer();
		dataTransfer.items.add(file);
		fileInput.files = dataTransfer.files;

		removeFileButton.style.display = 'inline-block'; // Muestra el botón para quitar la foto
		}, 'image/png');

		video.style.display = 'none';
		snap.style.display = 'none';
		});

		fileInput.addEventListener('change', function () {
		if (this.files.length > 0) {
		const reader = new FileReader();
		reader.onload = function (e) {
		photo.src = e.target.result;
		photo.style.display = 'block';
		};
		reader.readAsDataURL(this.files[0]);
		fileNameContainer.textContent = this.files[0].name;
		removeFileButton.style.display = 'inline-block';
		cameraButton.style.display = 'none'; // Oculta el botón de la cámara cuando se selecciona un archivo
		selectButtonLabel.style.display = 'none'; // Asegúrate de que este también se oculta
		}
		});

		removeFileButton.addEventListener('click', function () {
		fileInput.value = '';
		fileNameContainer.textContent = '';
		photo.src = '';
		photo.style.display = 'none';
		this.style.display = 'none';
		selectButtonLabel.style.display = 'block'; // Muestra nuevamente el botón de seleccionar
		cameraButton.style.display = 'block'; // Muestra nuevamente el botón de la cámara
		});

		});
	</script>
{% endblock %}
