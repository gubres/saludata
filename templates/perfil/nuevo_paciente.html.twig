{% extends 'base.html.twig' %}

{% block stylesheets %}
{{ parent() }}
<style>
    .container {
        max-width: 70%; /* Limita el ancho máximo del contenedor a 50% de la página */
        margin: auto; /* Centra el contenedor horizontalmente */
        padding-top: 20px; /* Espacio superior para evitar que esté demasiado pegado al encabezado */
    }

    .card {
        background: #ffffff; /* Fondo blanco para el estilo card */
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra sutil para dar profundidad */
        padding: 20px; /* Padding interno para el contenido */
        border-radius: 8px; /* Bordes redondeados */
    }

    .form-group {
        display: flex;
        align-items: center; /* Alinea verticalmente los elementos del formulario */
        margin-bottom: 10px; /* Margen para separar los campos del formulario */
    }

    .form-group label {
        flex: 0 0 180px; /* Ancho fijo para los labels */
        margin-right: 10px; /* Espacio entre el label y el input */
    }

    .form-control {
        flex: 1; /* Ocupa el espacio restante en la línea */
    }

#file-display-container {
    display: flex;
    align-items: center;
    gap: 10px;  /* Espaciado entre elementos dentro del contenedor */
}

#video, #photo {
    max-width: 50%;
    height: auto;  /* Ajusta esto para que se vea bien en tu diseño */
    margin-bottom: 10px;
}

    .btn {
        width: fit-content;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        white-space: nowrap;
    }

    .btn-primary {
        color: white;
        background-color: #007bff; /* Azul para botones primarios e informativos */
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn:hover {
        opacity: 0.85;
    }

#file-name {
    margin-right: 10px;
}

    </style>
{% endblock %}

{% block title %}Registro de Paciente{% endblock %}

{% block body %}
{% if is_granted('IS_AUTHENTICATED_FULLY') %}
<main class="flex-1 pt-3">
    <section class="container">
        <article class="card text-center">
            <h5 class="pt-3 mt-3">NUEVO PACIENTE</h5>
            <form id="registerPatientForm" method="post" action="{{ path('app_registar_paciente') }}" enctype="multipart/form-data" onsubmit="submitPatient">
                <div class="form-group">
                    <label>Selecciona una imagen o toma una foto al paciente:</label>
                    <div id="file-display-container" class="mb-5 mt-3 ">
                        <input type="file" id="image-upload" name="imagen" accept="image/png, image/jpeg, image/gif, image/webp" style="display: none;">
                        <label for="image-upload" class="btn btn-info bi bi-images"> Seleccionar una foto</label>
                        <button type="button" id="camera-button" class="btn btn-info bi bi-camera2"> Usar cámara</button>
                        <button type="button" id="remove-file" class="btn btn-danger mt-2 mb-2" style="display: none;">Borrar imagen</button>
                        <span id="file-name"></span>
                    </div>
                    <video id="video" autoplay class="mb-3" style="display: none;"></video>
                    <button id="snap" class="btn btn-primary mx-3" style="display: none;">Capturar Foto</button>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <img id="photo" class="mb-3" style="display: none;">
                </div>
                <div class="form-group">
                    <label>Nombre</label>    <input class="form-control" type="text" name="nombre" placeholder="Nombre" required>
                    </div>
                    <div class="form-group">
                    <label>Apellidos</label>    <input class="form-control" type="text" name="apellidos" placeholder="Apellidos" required>
                     </div>
                  <div class="form-group">
                    <label>DNI</label>    <input class="form-control" type="text" name="dni" placeholder="DNI" required>
                    </div>
               <div class="form-group">
                     <label>Fecha Nacimiento</label>   <input class="form-control" type="date" name="fecha_nacimiento" required>
                    </div>
                 <div class="form-group">
                    <label>Profesion</label>    <input class="form-control" type="text" name="profesion" placeholder="Profesión">
                    </div>
                <div class="form-group">
                    <label>Dirección</label>    <input class="form-control" type="text" name="direccion" placeholder="Dirección">
                    </div>
               <div class="form-group">
                    <label>Seleccione el género</label>
                        <select class="form-control" id="genderSelect" name="genero" required>
                            <option value="hombre-cis">Hombre Cis</option>
                            <option value="hombre-trans">Hombre Trans</option>
                            <option value="mujer-cis">Mujer Cis</option>
                            <option value="mujer-trans">Mujer Trans</option>
                            <option value="non-binario">Non-Binario</option>
                            <option value="neutro">Neutro</option>
                            <option value="agenero">Agenero</option>
                            <option value="pangenero">Pangenero</option>
                            <option value="queer">Queer</option>
                            <option value="no-identificar">No Identificar</option>
                        </select>
                    </div>
                 <div class="form-group">
                    <label>Seleccione el estado civil</label>
                        <select class="form-control" name="estado_civil" required>
                            <option value="soltero(a)">Soltero(a)</option>
                            <option value="casado(a)">Casado(a)</option>
                            <option value="viudo(a)">Viudo(a)</option>
                            <option value="pareja de hecho">Pareja de Hecho</option>
                            <option value="no identificar">No Identificar</option>
                        </select>
                    </div>
                <div class="form-group">
                    <label>ID Sanitario</label>
                    <input class="form-control" type="text" name="sanitario_asignado" placeholder="{{ app.user.id }}" readonly>
                    </div>
                  <div class="form-group">
                    <label>Telefono</label>
                    <input class="form-control" type="tel" name="telefono" placeholder="Telefono de Contacto">
                     </div>
                <div class="form-group">
                    <label>Email</label>
                    <input class="form-control" type="email" name="email" placeholder="Email de Contacto">
                </div>
               
                <div class="align-self-center p-3">
                    
                    <button type="submit" class="btn btn-primary bi bi-check2-square"> Registrar Paciente</button>
                   <a href="{{ path('app_perfil') }}" class="btn btn-secondary bi bi-person-lines-fill">
                    Volver a la lista
                    </a>
                </div>
                </form>
</article>
</section>
</main>
{% endif %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('image-upload');
    const cameraButton = document.getElementById('camera-button');
    const selectButtonLabel = document.querySelector('label[for="image-upload"]');
    const fileNameContainer = document.getElementById('file-name');
    const removeFileButton = document.getElementById('remove-file');
    const video = document.getElementById('video');
    const snap = document.getElementById('snap');
    const photo = document.getElementById('photo');
    const canvas = document.getElementById('canvas');

    cameraButton.addEventListener('click', function() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                video.style.display = 'block';
                snap.style.display = 'block';
                video.srcObject = stream;
                video.play();
                selectButtonLabel.style.display = 'none';  // Oculta el botón de seleccionar archivo
                cameraButton.style.display = 'none';  // Oculta el botón de usar cámara
            }).catch(function(error) {
                console.error("Error accessing the camera: " + error);
            });
        }
    });

    snap.addEventListener('click', function() {
        var desiredWidth = video.videoWidth;
        var desiredHeight = video.videoHeight;
        var aspectRatio = video.videoWidth / video.videoHeight;
        if (desiredWidth > 400) {
            desiredWidth = 400;
            desiredHeight = desiredWidth / aspectRatio;
        }
        canvas.width = desiredWidth;
        canvas.height = desiredHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, desiredWidth, desiredHeight);
        photo.src = canvas.toDataURL('image/png');
        photo.style.display = 'block';
        video.srcObject.getTracks().forEach(track => track.stop());

         // Convertir canvas a Blob y luego asignarlo como valor del input file
        canvas.toBlob(function(blob) {
            const file = new File([blob], "captura.png", { type: "image/png" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            removeFileButton.style.display = 'inline-block';  // Muestra el botón para quitar la foto
        }, 'image/png');


        video.style.display = 'none';
        snap.style.display = 'none';
        removeFileButton.style.display = 'inline-block';  // Muestra el botón para quitar la foto
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileNameContainer.textContent = this.files[0].name;
            removeFileButton.style.display = 'inline-block';
            cameraButton.style.display = 'none';  // Oculta el botón de la cámara cuando se selecciona un archivo
            selectButtonLabel.style.display = 'none';  // Asegúrate de que este también se oculta
        }
    });

    removeFileButton.addEventListener('click', function() {
        fileInput.value = '';
        fileNameContainer.textContent = '';
        photo.src = '';
        photo.style.display = 'none';
        this.style.display = 'none';
        selectButtonLabel.style.display = 'block';  // Muestra nuevamente el botón de seleccionar
        cameraButton.style.display = 'block';  // Muestra nuevamente el botón de la cámara
    });

});




</script>

{% endblock %}